#!/bin/bash
#
# kubectl-kubeplugin: Simple plugin to show CPU/Memory usage for resources
#

set -euo pipefail

NAMESPACE="${1:-kube-system}"
RESOURCE="${2:-pods}"

# Retrieve resource usage statistics from Kubernetes
if ! OUTPUT=$(kubectl top "$RESOURCE" -n "$NAMESPACE" 2>/dev/null); then
  echo "❌ Error: failed to get resource usage. Make sure metrics-server is installed." >&2
  exit 1
fi

# Заголовок
echo "Resource, Namespace, Name, CPU, Memory"

 # Extract CPU and memory usage from the output
echo "$OUTPUT" | tail -n +2 | while read -r line; do
  NAME=$(echo "$line" | awk '{print $1}')
  CPU=$(echo "$line" | awk '{print $2}')
  MEMORY=$(echo "$line" | awk '{print $3}')
  
# Output the statistics to the console
  echo "$RESOURCE, $NAMESPACE, $NAME, $CPU, $MEMORY"
done
